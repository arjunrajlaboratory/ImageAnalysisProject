FROM ubuntu:jammy as base
LABEL isUPennContrastWorker=True

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -qy tzdata && \
  apt-get install -qy software-properties-common python3-software-properties && \
  apt-get update && apt-get install -qy \
  build-essential \
  wget \
  python3 \
  r-base \
  libffi-dev \
  libssl-dev \
  libjpeg-dev \
  zlib1g-dev \
  r-base \
  git \
  libpython3-dev \
  tini && \
  apt-get clean && rm -rf /var/lib/apt/lists/*

ENV PATH="/root/miniforge3/bin:$PATH"
ARG PATH="/root/miniforge3/bin:$PATH"

# Auto-detect architecture and install appropriate Miniforge
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "aarch64" ]; then \
        MINIFORGE_URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh"; \
    else \
        MINIFORGE_URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh"; \
    fi && \
    wget $MINIFORGE_URL -O miniforge.sh && \
    mkdir /root/.conda && \
    bash miniforge.sh -b -p /root/miniforge3 && \
    rm miniforge.sh

FROM base as build

COPY ./workers/annotations/random_square/environment.yml /
RUN conda env create --file /environment.yml
SHELL ["conda", "run", "-n", "worker", "/bin/bash", "-c"]

# Install UPennContrast client
WORKDIR /
RUN git clone https://github.com/arjunrajlaboratory/NimbusImage
WORKDIR /NimbusImage
RUN bash -c "source $(conda info --base)/etc/profile.d/conda.sh && conda activate worker && pip install -r devops/girder/annotation_client/requirements.txt"
RUN bash -c "source $(conda info --base)/etc/profile.d/conda.sh && conda activate worker && pip install -e devops/girder/annotation_client/"

COPY ./annotation_utilities /annotation_utilities
WORKDIR /annotation_utilities
RUN pip install .

COPY ./worker_client /worker_client
WORKDIR /worker_client
RUN pip install .

COPY ./workers/annotations/random_square/entrypoint.py /

LABEL isUPennContrastWorker="" \
      isAnnotationWorker="" \
      interfaceName="Random square" \
      interfaceCategory="random" \
      description="Creates random square annotations"

ENTRYPOINT ["tini", "--", "conda", "run", "--no-capture-output", "-n", "worker", "python", "/entrypoint.py"]